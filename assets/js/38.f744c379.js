(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{395:function(t,s,a){"use strict";a.r(s);var o=a(25),c=Object(o.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"使用数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用数据库"}},[t._v("#")]),t._v(" 使用数据库")]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("这里是"),a("strong",[t._v("正在施工")]),t._v("的 koishi v2 的文档。要查看 v1 版本的文档，请前往"),a("a",{attrs:{href:"https://koishijs.github.io/v1/",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("这里")]),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("p",[t._v("在之前的章节中，我们已经看到 Koishi 内部实现了一套权限管理系统，这需要对数据库的支持。但是另一方面，为了保证纯粹性，Koishi 的核心库 koishi-core 并不希望写入对某个具体的数据库的支持。因此，Koishi 的数据库采取了注入的方法。因此插件开发者大可不必同时担心 Koishi 使用了自己不了解的数据库框架——因为任何数据库在 Koishi 的调用中都提供了相同的接口。")]),t._v(" "),a("h2",{attrs:{id:"安装数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装数据库"}},[t._v("#")]),t._v(" 安装数据库")]),t._v(" "),a("p",[t._v("正如上面所说的，如果你是 Koishi 的插件开发者，你可能不需要关心具体的数据库实现（除非你本身需要新的表来存储数据）。但是如果你是 Koishi 的使用者，只有当安装了数据库你才能正常使用所有的特性。首先你需要安装数据库依赖：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("# 我们以 mysql 数据库为例")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("# 与插件类似，数据库支持通常以 koishi-database- 开头")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("npm i koishi-database-mysql")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("# 或 yarn add koishi-database-mysql")])])])]),a("h3",{attrs:{id:"使用配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用配置文件"}},[t._v("#")]),t._v(" 使用配置文件")]),t._v(" "),a("p",[t._v("然后如果你使用的是 "),a("RouterLink",{attrs:{to:"/guide/config-file.html"}},[t._v("配置文件")]),t._v("，你可以向文件中添加 "),a("code",[t._v("database")]),t._v(" 属性：")],1),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      host: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[host]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      port: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("3306")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      user: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'root'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      password: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[password]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      database: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[database]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("h3",{attrs:{id:"使用-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-api"}},[t._v("#")]),t._v(" 使用 API")]),t._v(" "),a("p",[t._v("对于 Koishi API 的使用者，你需要手动引入这个数据库，并将相同的配置传入 "),a("RouterLink",{attrs:{to:"/api/app.html"}},[t._v("App")]),t._v(" 的构造选项中：")],1),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { App, startAll } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-database-mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      host: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[host]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      port: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("3306")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      user: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'root'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      password: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[password]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      database: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'[database]'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("startAll")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])])])]),a("h3",{attrs:{id:"安装多个数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装多个数据库"}},[t._v("#")]),t._v(" 安装多个数据库")]),t._v(" "),a("p",[t._v("你也可以在一个 Koishi 项目中使用多个数据库，例如用 mysql 存储教学对话，用 leveldb 存储用户数据。方法也很简单，只需在 database 属性中添加其他的值即可：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-database-mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-database-level'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" app ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql: { ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("/* mysql configuration */")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    level: { ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("/* leveldb configuration */")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("h3",{attrs:{id:"解决数据库冲突"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决数据库冲突"}},[t._v("#")]),t._v(" 解决数据库冲突")]),t._v(" "),a("p",[t._v("尽管我们可以让多个数据库同时运行，但是上面的配置却无法指定每个数据库管理哪部分数据。也就是说数据库之间可能存在在 API 冲突。这种情况下可能需要你手动解决这些冲突，方法很简单，只需在 "),a("code",[t._v("config.database")]),t._v(" 中加入一个 "),a("code",[t._v("$tables")]),t._v(" 属性，显式地说明哪张表用哪个数据库管理即可：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    $tables: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      user: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      group: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'level'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql: { ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("/* mysql configuration */")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    level: { ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("/* leveldb configuration */")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("h2",{attrs:{id:"调用数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调用数据库"}},[t._v("#")]),t._v(" 调用数据库")]),t._v(" "),a("p",[t._v("你可以通过访问 "),a("code",[t._v("ctx.database")]),t._v(" 来调用数据库接口：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 获取用户数据")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("await")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 修改群数据")]),t._v("\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("await")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("setGroup")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id, { assignee: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123456789")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])])])]),a("p",[t._v("你可以在后面的 "),a("RouterLink",{attrs:{to:"/api/database.html"}},[t._v("API")]),t._v(" 文档中看到全部内置的数据库 API。不过在这里我先介绍一下 Koishi 的数据库接口的几种设计，方便理解。")],1),t._v(" "),a("h3",{attrs:{id:"常见的接口设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见的接口设计"}},[t._v("#")]),t._v(" 常见的接口设计")]),t._v(" "),a("p",[t._v("下面的代码展示了一个 Koishi 数据库最常见的接口设计，它广泛地运用于各种插件中：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 向数据库中获取一行，可以采用 getXXX(id, fields) 的形式")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 其中 id 是该行的标识符，fields 是需要的字段")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 对于有些数据库这个参数是自动忽略的，无论填写什么都会返回一切字段")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果该行存在则返回该行的对应字段，否则返回 null")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getSchedule")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id, fields)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 向数据库中添加一行，可以采用 createXXX(data) 的形式")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 其中 data 是一个键值对；返回值是添加的行的完整数据（包括自动生成的 id 和默认属性等）")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("createSchedule")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(data)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 修改数据库中的一行，可以采用 setXXX(id, data) 的形式")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 其中 id 是该行的标识符，data 是要更改的数据")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 修改时只会用 data 中的键进行覆盖，不会影响未记录在 data 中的资源")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("setSchedule")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id, data)")])])])]),a("h3",{attrs:{id:"合并获取和插入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#合并获取和插入"}},[t._v("#")]),t._v(" 合并获取和插入")]),t._v(" "),a("p",[t._v("对于 Koishi 内部的两个抽象表 users 和 groups，情况略有不同。由于这两个表的访问量非常大，同时可能有许多未记录的数据请求，因此 Koishi 对这两个表采取了合并获取和插入的方法。你可以看到，在这种情况下将不需要使用 createXXX 方法就能插入新的行：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 中间增加了一个第二参数，表示默认情况下的权限等级")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果找到该用户，则不修改任何数据，返回该用户本身")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果未找到该用户，且 authority 小于 0，则返回 null")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 否则创建一个新的用户数据，权限为 authority")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果 authority 大于 0，则将新的用户数据添加到表中")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id, authority, fields)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 中间增加了一个第二参数，表示默认情况下的 assignee")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果找到该群，则不修改任何数据，返回该群本身")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果未找到该群，则创建一个新的群，代理者为 selfId")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果 selfId 大于 0，则将新的群数据添加到表中")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getGroup")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id, selfId, fields)")])])])]),a("h3",{attrs:{id:"使用观察者"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用观察者"}},[t._v("#")]),t._v(" 使用观察者")]),t._v(" "),a("p",[t._v("由于 Koishi 采取了中间件的处理流程，很可能发生用户数据在多个阶段都被修改的情况。如果每次修改都上传数据，势必会造成不必要的性能损失；如果每次修改不上传而是仅仅缓存，延迟的上传则可能导致必须上传所有字段，且有多个实例上传数据冲突的风险。对于这种情况，Koishi 设计了一套"),a("strong",[t._v("观察者模式")]),t._v("，可以让你更轻松地管理用户数据：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 创建一个观察者")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("await")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("observeUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(id)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 在多个中间件中修改用户数据")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("user.name ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("user.money ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("+=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("100")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("updateActivity")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(user.activity, ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123456789")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 上传更新")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("user.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("_update")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])])])]),a("p",[t._v("在上面的例子中，数据分成几次更新，但直到最后才进行上传。且由于观察者会记录每次的变化，使得最后更新时只修改之前变动的字段成为可能。更重要的是，这个更新时 Koishi 隐式地为你完成的，因此你"),a("strong",[t._v("甚至无需手动更新数据")]),t._v("，只要你直接在中间件中修改 "),a("code",[t._v("meta.$user")]),t._v(" 的数据即可。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("观察者的局限性和优化措施")]),t._v(" "),a("p",[t._v("如果你是插件开发者，这里有一些观察者的局限性需要提醒你。由于观察者本质上还是要延迟更新，因此为了确保数据安全，如果 "),a("code",[t._v("meta.$user")]),t._v(" 已经被改动，你应当尽量在异步操作开始前手动进行 "),a("code",[t._v("meta.$user._update()")]),t._v(" 的调用。")]),t._v(" "),a("p",[t._v("顺便一提，一旦成功执行了观察者的 "),a("code",[t._v("_update()")]),t._v(" 方法，之前的缓冲区将会被清空，因此之后不会重复更新数据；对于缓冲区为空的观察者，"),a("code",[t._v("_update()")]),t._v(" 方法也会直接返回，不会产生任何的数据库访问。这些都是我们优化的几个细节。")])]),t._v(" "),a("h2",{attrs:{id:"向数据库中注入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#向数据库中注入"}},[t._v("#")]),t._v(" 向数据库中注入")]),t._v(" "),a("p",[t._v("由于 Koishi 的数据库实现使用了注入策略，因此无论是字段，表，方法还是数据库都是可以注入的。")]),t._v(" "),a("h3",{attrs:{id:"注入字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注入字段"}},[t._v("#")]),t._v(" 注入字段")]),t._v(" "),a("p",[t._v("向内置的 users 和 groups 两张表中注入字段的方式如下：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { extendUser } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 向用户数据库中注入字段 foo，默认值为 'bar'")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extendUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(() ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ({ foo: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" }))")])])])]),a("p",[t._v("如果你是 TypeScript 用户，你可能还需要进行定义合并：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { extendUser } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("declare")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-core/dist/database'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("UserData")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    foo")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("string")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extendUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(() ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ({ foo: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" }))")])])])]),a("h3",{attrs:{id:"注入方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注入方法"}},[t._v("#")]),t._v(" 注入方法")]),t._v(" "),a("p",[t._v("向数据库中添加新的表，你并不需要对表进行描述（虽然只有这样才能让其他人对你的表进行二次注入，但如果你没有这种需求你当然可以不这么做），只需调用 "),a("code",[t._v("injectMethods()")]),t._v(" 方法添加新的数据库方法：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { injectMethods } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 第一个参数声明这个方法依赖于 mysql 数据库")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 第二个参数表明这次调用注入的是 user 表")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("injectMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'user'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("args")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 此时这里的 this 就变成了一个 MysqlDatabase 对象")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 这也是 koishi-database-mysql 的导出之一")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" this.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(sql)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("p",[t._v("这也依赖，你就可以直接调用刚刚定义的方法了：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.database.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])])])]),a("p",[t._v("如果你是 TypeScript 用户，你可能还需要进行定义合并：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { injectMethods } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 这里需要手动导入 MysqlDatabase 的类型")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 你应该将 koishi-database-mysql 作为插件的 devDependency")]),t._v("\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 尽量使用 import {}，这样可以不产生任何输出，有助于明确依赖关系")]),t._v("\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {} ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-database-mysql'")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("declare")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-core/dist/database'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("UserMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("args")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("SomeType")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("SomeType")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("injectMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'user'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("args")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 这里已经可以进行类型推断了")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" this.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(sql)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("有关注入方法的 this")]),t._v(" "),a("p",[t._v("在所有注入方法中，你的 "),a("code",[t._v("this")]),t._v(" 都可以访问到同时注册的其他方法和这些注入方法绑定的子数据库本身。")])]),t._v(" "),a("h3",{attrs:{id:"注入表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注入表"}},[t._v("#")]),t._v(" 注入表")]),t._v(" "),a("p",[t._v("尽管注入表不需要你在 JavaScript 中进行额外的操作，但是如果你是 TypeScript 使用者，你需要对注入的表进行定义，就像这样：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MyTableData")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  myData")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("SomeType")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MyTableMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("args")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("SomeType")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MyTableData")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("declare")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-core/dist/database'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("TableData")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    myTable")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MyTableData")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("TableMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    myTable")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MyTableMethods")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("injectMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'myTable'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("myMethod")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" () {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" this.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(sql)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("h2",{attrs:{id:"定义新的数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定义新的数据库"}},[t._v("#")]),t._v(" 定义新的数据库")]),t._v(" "),a("p",[t._v("最后，让我们介绍一下如何定义新的数据库。与上面介绍的方法类似，我们也采用注入的方式，不过这次我们需要先实现一个类。我们用 mysql 来举个例子：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { createPool } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { registerDatabase } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("class")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MysqlDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("constructor")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("config")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {}) {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    this.pool ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("createPool")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(config)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("sql")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("string")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("values")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("?:")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("any")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Promise")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("<")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("any")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("> ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Promise")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("((")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("reject")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      this.pool.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(sql, values, (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("error")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("results")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("fields")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (error) {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("reject")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(error)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("else")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(results)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("registerDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", MysqlDatabase)")])])])]),a("p",[t._v("对于 TypeScript 的使用者，你可以像这样进行类型合并：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { createPool, Pool, PoolConfig } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),t._v("\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { registerDatabase } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi'")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("declare")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-core/dist/database'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Subdatabases")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MysqlDatabase")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("interface")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("DatabaseConfig")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    mysql")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("PoolConfig")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("class")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("MysqlDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  pool")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Pool")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("constructor")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("config")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("PoolConfig")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {}) {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    this.pool ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("createPool")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(config)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("sql")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("string")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("values")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("?:")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("any")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v(":")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Promise")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("<")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("any")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("> {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("Promise")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("((")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("reject")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      this.pool.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("query")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(sql, values, (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("error")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("results")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("fields")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (error) {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("reject")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(error)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("else")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(results)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("        }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("registerDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'mysql'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", MysqlDatabase)")])])])]),a("p",[t._v("当然，完整的 "),a("a",{attrs:{href:"https://github.com/koishijs/koishi-database-mysql",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("koishi-database-mysql")]),a("OutboundLink")],1),t._v(" 要比上面的例子复杂的多，我们还需要处理有关数据库的更多细节。")]),t._v(" "),a("h3",{attrs:{id:"数据库的启动和停止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库的启动和停止"}},[t._v("#")]),t._v(" 数据库的启动和停止")]),t._v(" "),a("p",[t._v("然而很多数据库并没有像上面写的这么简单——例如数据库的加载可能包含一些异步操作，这些操作是不适合在构造函数中完成的；如果你希望你的应用平稳地停止，也最好提供一个数据库的中止函数。这些接口将由你来提供，只需在你传入的 Database 类中添加 "),a("code",[t._v("start")]),t._v(" 和 "),a("code",[t._v("stop")]),t._v(" 两个方法即可。这两个方法都可以是异步的：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("class")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("CustomDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("async")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("start")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" () {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("await")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("doSomeAsyncWorks")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("async")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("stop")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" () {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("await")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("doSomeAsyncWorks")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("registerDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'custom'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", CustomDatabase)")])])])]),a("h3",{attrs:{id:"数据库的复用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库的复用"}},[t._v("#")]),t._v(" 数据库的复用")]),t._v(" "),a("p",[t._v("在 "),a("RouterLink",{attrs:{to:"/guide/multiple-bots.html"}},[t._v("多机器人开发")]),t._v(" 一章中，我们会讨论到数据库实例的复用。诚然，复用数据库实例这件事是 Koishi 内部完成的，但如果你在某些时刻的确需要使用独立的数据库实例，你就需要了解数据库复用的原理。")],1),t._v(" "),a("p",[t._v("最简单的方式就是在对应数据库的参数中手动设置 "),a("code",[t._v("identifier")]),t._v(" 属性，不同的标识符将提示 Koishi 构造不同的数据库实例：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    custom: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      identifier: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("1")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// other configurations")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    custom: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      identifier: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("2")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// other configurations")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}]")])])])]),a("p",[t._v("除此以外，Koishi 也提供了隐式的标识符设计。向你的数据库类添加一个静态方法 "),a("code",[t._v("identiy")]),t._v("，这个函数将传入一个将要传给构造函数的 "),a("code",[t._v("config")]),t._v(" 对象，返回一个字符串或数字，这个返回值将会成为该数据库的标识符，并将作为传入构造函数的配置的 "),a("code",[t._v("identifier")]),t._v(" 属性。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("class")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("CustomDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("static")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("identify")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("config")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" config.path")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("constructor")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("config")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("console")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("log")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(config.identifier)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("registerDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'custom'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", CustomDatabase)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    custom: { path: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    custom: { path: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("App")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  database: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    custom: { path: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("p",[t._v("例如上面的代码将只产生两个输出。")]),t._v(" "),a("h3",{attrs:{id:"配置每个表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置每个表"}},[t._v("#")]),t._v(" 配置每个表")]),t._v(" "),a("p",[t._v("很多数据库都提供了表（Table）作为二级结构，Koishi 也为这种结构提供了原生的支持。然而，像 leveldb 这种基于键值对的数据库并没有这种结构，对于这种情况，Koishi 中则将表封装成了一个子数据库。因此在这种情况下，你甚至可以对每个表分别进行配置。额外的配置可以作为 "),a("code",[t._v("injectMethods")]),t._v(" 的第三个参数，同时它们将被传入你的数据库的构造函数，就像这样：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("class")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("LevelDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("constructor")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("config")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("tables")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("console")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("log")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(tables)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("registerDatabase")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'level'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", LevelDatabase)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("injectMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'level'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'user'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// some methods")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}, {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  keyEncoding: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'utf8'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("injectMethods")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'level'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// some methods")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}, {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  valueEncoding: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'json'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("p",[t._v("这里的输出结果将形如：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("{")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v('"user"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": { ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v('"keyEncoding"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#CFCFC2"}},[t._v('"utf8"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v('"group"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": { ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v('"valueEncoding"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#CFCFC2"}},[t._v('"json"')]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("h3",{attrs:{id:"数据库访问原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库访问原理"}},[t._v("#")]),t._v(" 数据库访问原理")]),t._v(" "),a("p",[t._v("在本章的最后，我们简单介绍一个 Koishi 的数据库访问原理。尽管 Koishi 的核心库 koishi-core 本身不含任何具体的数据库逻辑，但是它却提供了一批注入接口。")]),t._v(" "),a("ul",[a("li",[t._v("当用户调用 "),a("code",[t._v("registerDatabase()")]),t._v(" 时，会向 koishi-core 提交一个新的子数据库类型。")]),t._v(" "),a("li",[t._v("当用户调用 "),a("code",[t._v("injectMethods()")]),t._v(" 时，koishi-core 会将新的方法记录在对应的数据库和对应的表上。同时如果传入了第三个参数，将先被保存下来。")]),t._v(" "),a("li",[t._v("当用户进行 "),a("code",[t._v("config.database.mysql")]),t._v(" 配置时，koishi-core 也会自动寻找已经定义过的子数据库 mysql，一旦找到，首先会根据 "),a("code",[t._v("identifier")]),t._v(" 或者 "),a("code",[t._v("identify")]),t._v(" 生成标识符，接着检查该数据库是否已经被构造，如果没有就构造出一个新的 "),a("code",[t._v("MysqlDatabase")]),t._v(" 实例。再之后根据 "),a("code",[t._v("config.database.$tables")]),t._v(" 提供的信息选取出要注入的方法，将这些方法绑定这个实例并传入 "),a("code",[t._v("app.database")]),t._v(" 中，这就实现了完整的注入和 "),a("code",[t._v("this")]),t._v(" 绑定。")]),t._v(" "),a("li",[t._v("当用户调用 "),a("code",[t._v("app.start()")]),t._v(" 或 "),a("code",[t._v("startAll()")]),t._v(" 时，koishi-core 会检查每个已经存在的数据库是否拥有 "),a("code",[t._v("start")]),t._v(" 方法，如果有就进行调用；当用户调用 "),a("code",[t._v("app.stop()")]),t._v(" 或 "),a("code",[t._v("stopAll()")]),t._v(" 时同理。")])])],1)}),[],!1,null,null,null);s.default=c.exports}}]);