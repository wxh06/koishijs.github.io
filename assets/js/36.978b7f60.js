(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{412:function(t,s,a){"use strict";a.r(s);var o=a(25),c=Object(o.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"插件与上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插件与上下文"}},[t._v("#")]),t._v(" 插件与上下文")]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("这里是"),a("strong",[t._v("正在施工")]),t._v("的 koishi v2 的文档。要查看 v1 版本的文档，请前往"),a("a",{attrs:{href:"https://koishijs.github.io/v1/",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[t._v("这里")]),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("p",[t._v("在 "),a("RouterLink",{attrs:{to:"/guide/config-file.html"}},[t._v("编写配置文件")]),t._v(" 一章中，我们已经了解了一部分有关插件的知识。而本章将会深入 Koishi 的插件系统，介绍插件的内部机制和运作方式。")],1),t._v(" "),a("h2",{attrs:{id:"使用插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用插件"}},[t._v("#")]),t._v(" 使用插件 (plugin)")]),t._v(" "),a("p",[t._v("首先让我们回顾一下你已经了解到的插件使用方法：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: [")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",            ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 安装本地插件 foo")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",              ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 安装插件 bar")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    [")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'baz'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", options],   ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 安装带配置的插件 baz")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ],")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("p",[t._v("对应着下面的代码：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-baz'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("), options)")])])])]),a("p",[t._v("那么，如果我希望其中的一部分插件只对部分群生效，这又应该如何实现呢？这就牵扯到另一个重要概念，也就是上下文。")]),t._v(" "),a("h2",{attrs:{id:"上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上下文"}},[t._v("#")]),t._v(" 上下文 (context)")]),t._v(" "),a("p",[t._v("一个"),a("strong",[t._v("上下文")]),t._v("描述了机器人的一种可能的运行环境。例如，如果一个接收器或中间件被绑定在了上面例子中的上下文，那么只有该环境下的事件才会触发对应的回调函数。之前介绍过的 "),a("code",[t._v("receiver")]),t._v(", "),a("code",[t._v("sender")]),t._v(", "),a("code",[t._v("middleware")]),t._v(" 以及 "),a("code",[t._v("plugin")]),t._v(" 这些 API 本质上都是上下文所提供的方法，而我们能在 "),a("code",[t._v("app")]),t._v(" 上调用这些方法只是因为 "),a("code",[t._v("App")]),t._v(" 对象本身也是一个上下文而已。")]),t._v(" "),a("p",[t._v("除去 "),a("code",[t._v("App")]),t._v(" 本身外，我们还可以通过 "),a("code",[t._v("App")]),t._v(" 原型链上的方法创建新的上下文：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.users ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由全部好友构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.groups ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由全部群构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.discusses ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由全部讨论组构成的上下文")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("user")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由好友 123 构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由群 123 构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("discuss")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由讨论组 123 构成的上下文")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.users.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由除了 123 以外的所有好友构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.groups.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由除了 123 以外的所有群构成的上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.discusses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 由除了 123 以外的所有讨论组构成的上下文")])])])]),a("p",[t._v("利用上下文，你可以非常方便地对每个环境进行分别配置：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 在所有环境注册中间件")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 当有人申请加群 123 时触发 listener")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").receiver.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'request/add'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", listener)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 安装插件对除了 987 以外的所有讨论组生效")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.discusses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("987")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-tools'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])])])]),a("p",[t._v("是不是非常方便呢？")]),t._v(" "),a("h3",{attrs:{id:"上下文组合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上下文组合"}},[t._v("#")]),t._v(" 上下文组合")]),t._v(" "),a("p",[t._v("有的时候，我们也需要将一些上下文组合在一起使用，例如描述两个上下文的并集。为此，Koishi 也提供了相应的方法：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 返回两个上下文的并集")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context1.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plus")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(context2)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 返回两个上下文的交集")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context1.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("intersect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(context2)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 返回两个上下文的差集")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context1.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("minus")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(context2)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 返回一个上下文的补集")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("inverse")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 判断上下文能否匹配元信息对象")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context.")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("match")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(meta)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 判断当前上下文是否完全包含了另一个上下文")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("context1.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("contain")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(context2)")])])])]),a("p",[t._v("这些方法会返回一个新的上下文，在其上使用监听器、中间件、指令或是插件就好像同时在多个上下文中使用一样。")]),t._v(" "),a("h3",{attrs:{id:"在配置文件中声明上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在配置文件中声明上下文"}},[t._v("#")]),t._v(" 在配置文件中声明上下文 "),a("Badge",{attrs:{text:"beta",type:"warn"}})],1),t._v(" "),a("p",[t._v("你也可以在配置文件中声明插件所在的上下文，不过这就牵扯到一种字符串语法。用分号分隔不同类型的上下文，每个类型后面可以通过“+”或者“-”表示包含和排除，再之后是用逗号隔开的 ID 列表。就像这样：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 在群 123, 456 上下文，除 789 以外的用户上下文和全部讨论组上下文中安装插件")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group+123,456;user-789;discuss'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": [")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      [")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", options],")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ],")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("p",[t._v("这相当于")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("456")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plus")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(app.users.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("789")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plus")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(app.discusses)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", options)")])])])]),a("h2",{attrs:{id:"开发插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开发插件"}},[t._v("#")]),t._v(" 开发插件")]),t._v(" "),a("p",[t._v("一个"),a("strong",[t._v("插件")]),t._v("的本质是以下两个之一：")]),t._v(" "),a("ul",[a("li",[t._v("一个接受两个参数的函数，第一个参数是所在的上下文，第二个参数是传入的选项")]),t._v(" "),a("li",[t._v("一个对象，其中的 "),a("code",[t._v("apply")]),t._v(" 方法是上面所说的函数")])]),t._v(" "),a("p",[t._v("因此，下面的三种写法是等价的：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback))")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback),")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),a("p",[t._v("插件化的写法能够帮助我们将多个逻辑组合在一起并模块化，同时可以在插件内部对所需的选项进行初始化，这些都能极大地提高了代码的可维护性。这是因为每个人都可以直接将代码以插件的形式导出成模块，之后插件名又可以被直接写在 "),a("code",[t._v("koishi.config.js")]),t._v(" 文件中。")]),t._v(" "),a("h3",{attrs:{id:"具名插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#具名插件"}},[t._v("#")]),t._v(" 具名插件")]),t._v(" "),a("p",[t._v("除此以外，插件如果使用对象式，那么除了 "),a("code",[t._v("apply")]),t._v(" 以外，你还可以提供一个 "),a("code",[t._v("name")]),t._v(" 属性。如果提供了这个属性，命令行工具会将这个名字输出到控制台中。例如，下面给出了一个插件的例子，它实现了检测说话带空格的功能：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"detect-space.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".name ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'detect-space'")]),t._v("\n\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("((")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("next")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (meta.message.")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("match")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("/")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("^")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\s")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("*")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\S")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("+")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("{2,}")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\S\\s")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("*$")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("/")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("g")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")) {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" meta.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$send")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'说话带空格，有罪！'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("else")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("next")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    }")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("p",[t._v("把它放到你的机器人文件夹，接着向你的 "),a("code",[t._v("koishi.config.js")]),t._v(" 添加一行：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: [")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 这里是其他插件")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    [")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'detect-space'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("],")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ],")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("p",[t._v("调用 "),a("code",[t._v("koishi run")]),t._v("，你就可以看到这个插件在正常运行了。")]),t._v(" "),a("h3",{attrs:{id:"嵌套插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌套插件"}},[t._v("#")]),t._v(" 嵌套插件")]),t._v(" "),a("p",[t._v("Koishi 的插件也是可以嵌套的。你可以将你编写的插件解耦成多个独立的子插件，再用一个父插件作为入口，就像这样：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi-plugin-foo/index.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 在 a.js, b.js 中编写两个不同的插件")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginA ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./a'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginB ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./b'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 将这两个插件输出")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".pluginA ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginA")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".pluginB ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginB")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 在 apply 函数中安装 a, b 两个插件")]),t._v("\n"),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(pluginA)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(pluginB)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),a("p",[t._v("这样别人就可以这样使用你的插件了：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果希望同时使用你的插件的全部功能")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 如果只希望启用一部分功能")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").pluginA)")])])])]),a("p",[t._v("Koishi 的官方插件 koishi-plugin-common 也使用了这种写法。")])],1)}),[],!1,null,null,null);s.default=c.exports}}]);