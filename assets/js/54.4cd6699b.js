(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{378:function(t,a,s){"use strict";s.r(a);var c=s(25),o=Object(c.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"存储聊天记录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存储聊天记录"}},[t._v("#")]),t._v(" 存储聊天记录 (recorder) "),s("Badge",{attrs:{text:"beta",type:"warn"}})],1),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("本章介绍的功能由 koishi-plugin-recorder 插件提供。")])]),t._v(" "),s("p",[t._v("koishi-plugin-recorder 提供了一种将聊天记录存储于本地文件的方式。")]),t._v(" "),s("h2",{attrs:{id:"使用方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[t._v("#")]),t._v(" 使用方法")]),t._v(" "),s("h3",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("npm i koishi-plugin-recorder")]),t._v("\n"),s("span",{staticStyle:{color:"#75715E"}},[t._v("# 或者")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("yarn add koishi-plugin-recorder")])])])]),s("h3",{attrs:{id:"使用配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用配置文件"}},[t._v("#")]),t._v(" 使用配置文件")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: [")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    [")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'recorder'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", options],")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ],")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])]),s("h3",{attrs:{id:"使用-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-api"}},[t._v("#")]),t._v(" 使用 API")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-recorder'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("), options)")])])])]),s("h2",{attrs:{id:"配置项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置项"}},[t._v("#")]),t._v(" 配置项")]),t._v(" "),s("h3",{attrs:{id:"target"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#target"}},[t._v("#")]),t._v(" target")]),t._v(" "),s("ul",[s("li",[t._v("类型: "),s("code",[t._v("(meta: Meta) => string | void")])]),t._v(" "),s("li",[t._v("默认值: 当不是群消息时无返回值，否则返回 "),s("code",[t._v("messages/${meta.groupId}.txt")])])]),t._v(" "),s("p",[t._v("要存放到的文件。如果文件不存在则连同所在的路径一起创建；如果文件已经存在则继续写在文件后。如果返回的不是绝对路径，则依照当前工作目录来解析。")]),t._v(" "),s("h3",{attrs:{id:"transform"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#transform"}},[t._v("#")]),t._v(" transform")]),t._v(" "),s("ul",[s("li",[t._v("类型: "),s("code",[t._v("(meta: Meta) => string")])]),t._v(" "),s("li",[t._v("默认值: 由元信息的 "),s("code",[t._v("$ctxType")]),t._v(", "),s("code",[t._v("$ctxId")]),t._v(", "),s("code",[t._v("userId")]),t._v(", "),s("code",[t._v("message")]),t._v(" 字段构成的 JSON")])]),t._v(" "),s("p",[t._v("将元信息转化成要输出的文本行。")]),t._v(" "),s("h2",{attrs:{id:"扩展事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#扩展事件"}},[t._v("#")]),t._v(" 扩展事件")]),t._v(" "),s("p",[t._v("koishi-plugin-recorder 插件会增加几个额外的事件，你可以利用这些钩子扩充你机器人的逻辑。")]),t._v(" "),s("h3",{attrs:{id:"事件：record-opened"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件：record-opened"}},[t._v("#")]),t._v(" 事件：record-opened")]),t._v(" "),s("p",[t._v("当一个新的输出流被创建完成时在 App 实例触发。传入两个参数，第一个是输出流 "),s("code",[t._v("WriteStream")]),t._v(" 对象，第二个是输出文件的绝对路径。")]),t._v(" "),s("h3",{attrs:{id:"事件：record-closing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件：record-closing"}},[t._v("#")]),t._v(" 事件：record-closing")]),t._v(" "),s("p",[t._v("当一个输出流被关闭时在 App 实例触发（默认情况下这只会发生在全部 App 都被关闭之后）。传入两个参数，第一个是输出流 "),s("code",[t._v("WriteStream")]),t._v(" 对象，第二个是输出文件的绝对路径。")]),t._v(" "),s("h3",{attrs:{id:"事件：record-writing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件：record-writing"}},[t._v("#")]),t._v(" 事件：record-writing")]),t._v(" "),s("p",[t._v("当插件即将新的文本行写入文件时在 App 实例触发。传入两个参数，第一个是要写入的文本行，第二个是元信息 "),s("code",[t._v("Meta")]),t._v(" 对象。")]),t._v(" "),s("h3",{attrs:{id:"事件：record-written"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件：record-written"}},[t._v("#")]),t._v(" 事件：record-written")]),t._v(" "),s("p",[t._v("当插件成功将新的文本行写入完成时在 App 实例触发。传入两个参数，第一个是要写入的文本行，第二个是元信息 "),s("code",[t._v("Meta")]),t._v(" 对象。")]),t._v(" "),s("h2",{attrs:{id:"避免重复记录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#避免重复记录"}},[t._v("#")]),t._v(" 避免重复记录")]),t._v(" "),s("p",[t._v("如果你在同一目录运行了多个机器人并且存在多机器人加同一个群的情况，那么你应当注意避免两个机器人同时对一条信息进行处理，导致重复记录的情况。下面举出两个具体的例子用于展示。")]),t._v(" "),s("h3",{attrs:{id:"使用-weakset-检测消息是否被记录过"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-weakset-检测消息是否被记录过"}},[t._v("#")]),t._v(" 使用 WeakSet 检测消息是否被记录过")]),t._v(" "),s("p",[t._v("koishi-plugin-recorder 的默认行为采用了 WeakSet 来检测消息是否被记录过。你可以参考下面的代码：")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" refs ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("new")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("WeakSet")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("<")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("Meta")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(">()")]),t._v("\n\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-recorder'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("target")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (refs.")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("has")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(meta) ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("||")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" meta.$ctxType ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("!==")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("`messages/${meta.groupId}.txt`")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("transform")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    refs.")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("add")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(meta)")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("JSON")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("stringify")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("pick")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(meta, [")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'$ctxType'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'$ctxId'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'message'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("]))")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),s("h3",{attrs:{id:"将不同机器人收到的信息存放于不同的目录下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将不同机器人收到的信息存放于不同的目录下"}},[t._v("#")]),t._v(" 将不同机器人收到的信息存放于不同的目录下")]),t._v(" "),s("p",[t._v("你也可以通过将不同机器人收到的信息存放于不同的目录下来避免对同一个文件的多次写入：")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-recorder'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("target")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (meta.$ctxType ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("!==")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("`messages/${app.selfId}/${meta.groupId}.txt`")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("transform")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") {")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("JSON")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("stringify")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("pick")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(meta, [")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'$ctxType'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'$ctxId'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'message'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("]))")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")]),t._v("\n"),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])])],1)}),[],!1,null,null,null);a.default=o.exports}}]);